{% extends "base.html" %}
{% block title %}Settings — ListHub{% endblock %}
{% block content %}
<h1 style="margin-bottom: 24px;">Settings</h1>

<h2 style="font-size: 16px; margin-bottom: 12px;">API Keys</h2>
<p style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">
    Use API keys to authenticate agents and scripts. Keys are shown only once when created.
</p>

<div id="new-key-result" style="display: none;">
    <div class="key-reveal">
        <strong>Save this key — it won't be shown again:</strong><br>
        <code id="new-key-value"></code>
    </div>
    <br>
</div>

<form id="create-key-form" style="display: flex; gap: 8px; margin-bottom: 24px;">
    <input type="text" id="key-name" placeholder="Key name (e.g. claude-code)" style="padding: 6px 12px; font-size: 13px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); flex: 1;">
    <button type="submit" class="btn btn-primary">Create Key</button>
</form>

{% if keys %}
<div>
    {% for key in keys %}
    <div class="key-card">
        <div class="key-info">
            <div class="key-name">{{ key.name }}</div>
            <div class="key-meta">{{ key.scopes }} &middot; Created {{ key.created_at[:10] if key.created_at else '' }}</div>
        </div>
        <button class="btn btn-sm btn-danger" onclick="deleteKey('{{ key.id }}', this)">Revoke</button>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state" style="padding: 24px;">
    <p>No API keys yet.</p>
</div>
{% endif %}

<script>
document.getElementById('create-key-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('key-name').value.trim() || 'default';
    const resp = await fetch('/api/v1/keys', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name})
    });
    if (resp.ok) {
        const data = await resp.json();
        document.getElementById('new-key-value').textContent = data.key;
        document.getElementById('new-key-result').style.display = 'block';
        document.getElementById('key-name').value = '';
        setTimeout(() => location.reload(), 3000);
    }
});

async function deleteKey(keyId, btn) {
    if (!confirm('Revoke this API key?')) return;
    const resp = await fetch('/api/v1/keys/' + keyId, {method: 'DELETE'});
    if (resp.ok) {
        btn.closest('.key-card').remove();
    }
}
</script>
{% endblock %}
