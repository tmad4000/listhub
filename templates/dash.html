{% extends "base.html" %}
{% block title %}Dashboard — ListHub{% endblock %}
{% block content %}
<div class="toolbar">
    <h1>Your Items</h1>
    <div style="display: flex; gap: 12px; align-items: center;">
        <form class="search-box" method="get" action="{{ url_for('views.dashboard') }}">
            <input type="text" name="q" placeholder="Search..." value="{{ q or '' }}">
            {% if view_mode == 'folders' %}<input type="hidden" name="view" value="folders">{% endif %}
        </form>
        <a href="{{ url_for('views.new_item') }}" class="btn btn-primary">New Item</a>
    </div>
</div>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <div class="filter-tabs">
        <a href="{{ url_for('views.dashboard', view=view_mode) }}" class="filter-tab {% if not visibility_filter %}active{% endif %}">All</a>
        <a href="{{ url_for('views.dashboard', visibility='public', view=view_mode) }}" class="filter-tab {% if visibility_filter == 'public' %}active{% endif %}">Public</a>
        <a href="{{ url_for('views.dashboard', visibility='shared', view=view_mode) }}" class="filter-tab {% if visibility_filter == 'shared' %}active{% endif %}">Shared</a>
        <a href="{{ url_for('views.dashboard', visibility='private', view=view_mode) }}" class="filter-tab {% if visibility_filter == 'private' %}active{% endif %}">Private</a>
    </div>
    <div class="view-toggle">
        <a href="{{ url_for('views.dashboard', visibility=visibility_filter, q=q) }}" class="btn btn-sm {% if view_mode != 'folders' %}btn-active{% endif %}" title="List view">List</a>
        <a href="{{ url_for('views.dashboard', view='folders', visibility=visibility_filter, q=q) }}" class="btn btn-sm {% if view_mode == 'folders' %}btn-active{% endif %}" title="Folder view">Folders</a>
    </div>
</div>

{% if items %}

{% if view_mode == 'folders' and folder_tree is not none %}
{# ── Tree view ── #}
<div class="tree-view">
    {% for node in folder_tree %}
        {% if node.type == 'folder' %}
        <div class="tree-folder" style="padding-left: {{ node.depth * 20 }}px;" data-depth="{{ node.depth }}">
            <div class="tree-folder-header" onclick="toggleFolder(this)">
                <span class="tree-arrow">&#9660;</span>
                <span class="tree-folder-icon">&#128193;</span>
                <span class="tree-folder-name">{{ node.name }}/</span>
                <span class="tree-folder-count">{{ node.count }}</span>
            </div>
        </div>
        {% else %}
        <div class="tree-file" style="padding-left: {{ node.depth * 20 + 24 }}px;" data-depth="{{ node.depth }}">
            <div class="tree-file-row">
                <div class="tree-file-info">
                    <span class="tree-file-icon">&#128196;</span>
                    <a href="{{ url_for('views.edit_item', item_id=node.item.id) }}" class="tree-file-name">{{ node.item.title or node.item.slug }}</a>
                    <span class="badge badge-{{ node.item.visibility }}">{{ node.item.visibility }}</span>
                    <span class="badge badge-{{ node.item.item_type }}">{{ node.item.item_type }}</span>
                    {% for tag in node.item.tags %}
                        <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                <div class="tree-file-actions">
                    <a href="/@{{ current_user.username }}/{{ node.item.slug }}" class="btn btn-sm">View</a>
                    <a href="{{ url_for('views.edit_item', item_id=node.item.id) }}" class="btn btn-sm">Edit</a>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>

<script>
function toggleFolder(header) {
    const folderDiv = header.parentElement;
    const depth = parseInt(folderDiv.dataset.depth);
    const arrow = header.querySelector('.tree-arrow');
    const isCollapsing = !folderDiv.classList.contains('collapsed');

    folderDiv.classList.toggle('collapsed');
    arrow.style.transform = isCollapsing ? 'rotate(-90deg)' : '';

    // Toggle all following siblings until we hit same or lower depth
    let next = folderDiv.nextElementSibling;
    while (next) {
        const nextDepth = parseInt(next.dataset.depth);
        if (nextDepth <= depth) break;
        next.style.display = isCollapsing ? 'none' : '';
        next = next.nextElementSibling;
    }
}
</script>

{% else %}
{# ── List view (default) ── #}
<div class="item-list">
    {% for item in items %}
    <div class="item-card">
        <div class="item-info">
            <a href="{{ url_for('views.edit_item', item_id=item.id) }}" class="item-title">{{ item.title or item.slug }}</a>
            <div class="item-meta">
                <span class="badge badge-{{ item.visibility }}">{{ item.visibility }}</span>
                <span class="badge badge-{{ item.item_type }}">{{ item.item_type }}</span>
                {% for tag in item.tags %}
                    <span class="tag">{{ tag }}</span>
                {% endfor %}
                <span>{{ item.updated_at[:16] if item.updated_at else '' }}</span>
                <span>rev {{ item.revision }}</span>
            </div>
        </div>
        <div class="item-actions">
            <a href="/@{{ current_user.username }}/{{ item.slug }}" class="btn btn-sm">View</a>
            <a href="{{ url_for('views.edit_item', item_id=item.id) }}" class="btn btn-sm">Edit</a>
            <form method="post" action="{{ url_for('views.delete_item', item_id=item.id) }}" style="display: inline;" onsubmit="return confirm('Delete this item?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <p>No items yet. Create your first one!</p>
    <a href="{{ url_for('views.new_item') }}" class="btn btn-primary">New Item</a>
</div>
{% endif %}
{% endblock %}
